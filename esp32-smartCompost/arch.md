# 智能堆肥系统架构文档

## 1. 项目概述
智能堆肥系统是一个基于ESP32的物联网设备，用于监测和控制堆肥过程中的关键参数（如CO2浓度、O2浓度、温度和湿度），并通过MQTT协议将数据上传到云端。系统支持远程控制（如启动/停止曝气泵和抽气泵）和定时任务功能。

## 2. 系统架构

### 2.1 硬件架构
- **主控芯片**: ESP32
- **传感器模块**:
  - MH-Z16 CO2传感器
  - DFRobot EOxygen O2传感器
  - DS18B20 温度传感器
  - FDS100 土壤湿度传感器
- **执行器模块**:
  - 抽气泵（用于采样）
  - 曝气泵（用于供氧）

### 2.2 软件架构

#### 2.2.1 主要模块
1. **WiFi/NTP/MQTT模块** (`wifi_ntp_mqtt.h/cpp`)
   - 负责WiFi连接、NTP时间同步和MQTT通信。
   - 提供MQTT客户端的维护和数据发布功能。

2. **传感器与执行器模块** (`sensor.h`)
   - 初始化传感器和执行器。
   - 提供传感器数据读取和执行器控制接口。

3. **配置管理模块** (`config_manager.h`)
   - 管理系统的配置参数（如WiFi、MQTT、传感器参数等）。
   - 支持从SPIFFS加载和保存配置。

4. **日志管理模块** (`log_manager.h`)
   - 提供日志记录功能，支持不同日志等级和日志文件大小限制。

5. **主程序模块** (`main.cpp`)
   - 系统初始化和主循环逻辑。
   - 实现周期测量任务和延迟命令任务。

#### 2.2.2 任务调度
- **周期测量任务**: 定时读取传感器数据并上传到云端。
- **延迟命令任务**: 处理远程控制命令和定时任务。

## 3. 数据流
1. **传感器数据采集**: 通过传感器模块读取环境参数。
2. **数据处理与上传**: 将数据格式化为JSON并通过MQTT发布。
3. **命令接收与执行**: 通过MQTT订阅接收控制命令并执行。

## 4. 关键功能
- **实时监测**: 定时采集并上传环境参数。
- **远程控制**: 支持通过MQTT远程控制执行器。
  - **命令格式**: 
    ```json
    {
      "device": "设备标识",
      "commands": [
        {
          "command": "aeration/exhaust",
          "action": "on/off",
          "duration": 持续时间（毫秒）,
          "schedule": "定时执行时间（格式：YYYY-MM-DD HH:MM:SS）"
        }
      ]
    }
    ```
  - **支持命令**:
    - `aeration`: 控制曝气泵（`on`启动，`off`关闭）。
    - `exhaust`: 控制抽气泵（`on`启动，`off`关闭）。
- **日志记录**: 记录系统运行状态和异常信息。
- **实时监测**: 定时采集并上传环境参数。
- **远程控制**: 支持通过MQTT远程控制执行器。
- **日志记录**: 记录系统运行状态和异常信息。

## 5. 依赖库
- **WiFi**: ESP32内置WiFi库。
- **PubSubClient**: MQTT客户端库。
- **ArduinoJson**: JSON数据处理库。
- **OneWire/DallasTemperature**: DS18B20温度传感器库。

## 6. 后续优化建议
1. **增加OTA升级功能**: 支持远程固件更新。
2. **优化传感器校准**: 提高数据准确性。
3. **扩展更多传感器**: 如pH传感器等。